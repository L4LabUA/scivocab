#!/usr/bin/env python

"""The create_db script creates an SQLite3 database that contains the tables
and data required for the app."""

import os
import sys
from app.models import (
    Word,
    Strand,
    BreadthTaskImage,
    BreadthTaskImageType,
    DepthTaskImage,
    DepthTaskImageType,
)
from flask_sqlalchemy import SQLAlchemy
from app import create_app, db
from sqlalchemy import create_engine
import pandas as pd
from app.config import Config
import click
from pathlib import Path
from glob import glob
import logging
from logging import info
from pathlib import Path


def create_word_tables():
    engine = create_engine(Config.SQLALCHEMY_DATABASE_URI, echo=False)
    current_app = create_app()
    current_app.config.from_object(Config)
    current_app.app_context().push()
    db.init_app(current_app)
    db_filepath = current_app.config["SQLITE3_DB_PATH"]

    if Path(db_filepath).exists():
        # Warn the user about the consequences of running the script and ask
        # them
        if not click.confirm(
            "This script will delete the existing database "
            f"({db_filepath}) and create a fresh one. "
            "Are you sure you want to continue?",
            default=False,
        ):
            info("Database creation canceled. Exiting now.")
            sys.exit(0)

    db.drop_all()
    db.create_all()

    basedir = os.path.abspath(os.path.dirname(__file__))
    static_dir = "static/scivocab"
    breadth_df = pd.read_csv(
        f"{basedir}/../app/static/scivocab/sv_bv1_input.csv"
    )

    info("Adding breadth ids, target words, and strand information")
    for row in breadth_df.itertuples():
        word = Word(
            id=row.target,
            breadth_id=row.breadth_id,
            strand=Strand(id=row.strand),
        )
        db.session.merge(word)
        breadth_task_image = BreadthTaskImage(
            target=row.target,
            filename=row.file,
            image_type=BreadthTaskImageType(id=row.img_type),
        )
        db.session.merge(breadth_task_image)

    basedir = os.path.abspath(os.path.dirname(__file__))
    static_dir = "static/scivocab"
    breadth_training_df = pd.read_csv(
        f"{basedir}/../app/static/scivocab/training/breadth/sv_bv1_training.csv"
    )

    info("Adding breadth ids, training words")
    for row in breadth_training_df.itertuples():
        word = Word(
            id=row.target,
            breadth_id=row.breadth_id,
        )
        db.session.merge(word)
        breadth_training_image = BreadthTaskImage(
            target=row.target,
            filename=row.file,
            image_type=BreadthTaskImageType(id=row.img_type),
        )
        db.session.merge(breadth_training_image)

    info("Inserting depth ids and audio filenames.")
    audio_df = pd.read_csv(f"{basedir}/../app/static/scivocab/audio.csv")

    for row in audio_df.itertuples():
        word = Word.query.filter_by(breadth_id=row.breadth_id).first()
        word.word_id = row.word_id
        if isinstance(row.depth_id, str):
            word.depth_id = row.depth_id
        word.audio_file = row.file
        db.session.merge(word)

    db.session.commit()

    info("Inserting depth task image filenames.")
    for f in glob(f"{basedir}/../app/static/scivocab/sv_dv1/*.jpg"):
        path = Path(f)
        filename = path.name
        stem_parts = path.stem.split("_")

        depth_task_image = DepthTaskImage(
            target=Word.query.filter_by(depth_id=stem_parts[1]).first().id,
            filename=filename,
            image_type=DepthTaskImageType(id=stem_parts[-1]),
        )
        db.session.merge(depth_task_image)

    info("Inserting depth training ids and audio filenames.")
    audio_df = pd.read_csv(
        f"{basedir}/../app/static/scivocab/training/depth/audio_training.csv"
    )

    for row in audio_df.itertuples():
        word = Word(
            id=row.target,
            breadth_id=row.breadth_id,
            depth_id=row.depth_id,
            audio_file=row.file,
        )
        db.session.merge(word)

    db.session.commit()

    info("Inserting depth task training image filenames.")
    for f in glob(f"{basedir}/../app/static/scivocab/sv_dv1/training/*.jpg"):
        path = Path(f)
        filename = "training/" + path.name
        stem_parts = path.stem.split("_")
        depth_training_image = DepthTaskImage(
            target=Word.query.filter_by(depth_id=stem_parts[1]).first().id,
            filename=filename,
            image_type=DepthTaskImageType(id=stem_parts[-1]),
        )
        db.session.merge(depth_training_image)

    db.session.commit()


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    create_word_tables()
